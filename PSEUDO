from ib_async import *
util.startLoop()

ib = IB()
ib.connect('127.0.0.1', 7497, clientId=0)

# GRAB APPROPRIATE SYMBOLS

sub = ScannerSubscription(
    instrument='STK', 
    locationCode='STK.NASDAQ',        # 'STK.US.MAJOR', 
    scanCode='TOP_PERC_GAIN')

tagValues = [
    TagValue("changePercAbove", "30"),
    TagValue('usdVolumeAbove', 0.10),
    TagValue('priceBelow', 10)]

# the tagValues are given as 3rd argument; the 2nd argument must always be an empty list
# (IB has not documented the 2nd argument and it's not clear what it does)
scanData = ib.reqScannerData(sub, [], tagValues)

symbols = [sd.contractDetails.contract.symbol for sd in scanData]
print(symbols)

# CREATE CONTRACTS FOR SAID SYMBOLS

contracts = [Forex(pair) for pair in ('EURUSD', 'USDJPY', 'GBPUSD', 'USDCHF', 'USDCAD', 'AUDUSD')]
ib.qualifyContracts(*contracts)

for contract in contracts:
    ib.reqMktData(contract, '', False, False)

# TRACK THE CONTRACTS / OR JUST MAKE SPLIT SECOND DECISIONS BASED ON WHAT THE DATA SAYS NOW.

# question: when we get historical bars (say last 5), do we get last 5 fully formed, or last 4 FF and the 5th currently forming in minute 4?

# track changing tickers every 30 seconds and update values
ib.pendingTickersEvent += onPendingTickers
ib.sleep(30)
ib.pendingTickersEvent -= onPendingTickers

# SET UP BRACKETED ORDERS (BASED ON POSITIVE MOVEMENT)

# LOG DATA FOR REVIEW

# LOOP THROUGHOUT DAYTIME

# Run infinitely
ib.run()
